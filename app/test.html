<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Timeline Drag</title>
    <style>
        .timeline-container {
            width: 600px;
            margin: 100px auto;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 10px; /* Space for scrollbar */
        }

        .timeline-container::-webkit-scrollbar {
            height: 8px;
        }

        .timeline-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .timeline-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .timeline-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .timeline {
            width: 2000px; /* Wider than container to enable scrolling */
            height: 60px;
            background: #eee;
            position: relative;
            border-radius: 10px;
        }

        .scrubber {
            width: 40px;
            height: 100%;
            background: #3498db;
            position: absolute;
            top: 0;
            left: 0;
            cursor: grab;
            border-radius: 10px;
            min-width: 20px;
        }

        .scrubber:active {
            cursor: grabbing;
        }

        .resize-handle {
            position: absolute;
            top: 0;
            height: 100%;
            width: 8px;
            cursor: ew-resize;
            z-index: 10;
        }

        .resize-handle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .resize-handle.left {
            left: 0;
            border-radius: 10px 0 0 10px;
        }

        .resize-handle.right {
            right: 0;
            border-radius: 0 10px 10px 0;
        }
    </style>
</head>

<body>

    <div class="timeline-container">
        <div class="timeline" id="timeline">
            <div class="scrubber" id="scrubber1">
                <div class="resize-handle left" id="leftHandle1"></div>
                <div class="resize-handle right" id="rightHandle1"></div>
            </div>
            <div class="scrubber" id="scrubber2">
                <div class="resize-handle left" id="leftHandle2"></div>
                <div class="resize-handle right" id="rightHandle2"></div>
            </div>
        </div>
    </div>

    <script>
        const scrubber1 = document.getElementById('scrubber1');
        const scrubber2 = document.getElementById('scrubber2');
        const timeline = document.getElementById('timeline');
        const timelineContainer = document.querySelector('.timeline-container');
        const leftHandle1 = document.getElementById('leftHandle1');
        const rightHandle1 = document.getElementById('rightHandle1');
        const leftHandle2 = document.getElementById('leftHandle2');
        const rightHandle2 = document.getElementById('rightHandle2');

        const INITIAL_TIMELINE_WIDTH = 2000;
        const EXPANSION_THRESHOLD = 200; // pixels from the end to trigger expansion
        const EXPANSION_AMOUNT = 1000; // how much to expand by each time
        let timelineWidth = INITIAL_TIMELINE_WIDTH;
        const containerWidth = timelineContainer.offsetWidth;
        const MINIMUM_WIDTH = 20;
        let isDragging = false;
        let isResizing = false;
        let resizeMode = null; // 'left' or 'right'
        let activeScrubber = null;
        let offsetX = 0;
        let startX = 0;
        let startLeft = 0;
        let startWidth = 0;

        function expandTimeline() {
            const currentScrollLeft = timelineContainer.scrollLeft;
            const scrollRight = currentScrollLeft + containerWidth;
            const distanceToEnd = timelineWidth - scrollRight;

            if (distanceToEnd < EXPANSION_THRESHOLD) {
                timelineWidth += EXPANSION_AMOUNT;
                timeline.style.width = `${timelineWidth}px`;
                return true;
            }
            return false;
        }

        function getScrubberBounds(scrubber) {
            const scrollLeft = timelineContainer.scrollLeft;
            return {
                left: scrubber.offsetLeft + scrollLeft,
                right: scrubber.offsetLeft + scrubber.offsetWidth + scrollLeft
            };
        }

        function checkCollision(scrubber1, scrubber2) {
            const bounds1 = getScrubberBounds(scrubber1);
            const bounds2 = getScrubberBounds(scrubber2);
            return !(bounds1.right <= bounds2.left || bounds1.left >= bounds2.right);
        }

        // Add scroll event listener to check for expansion
        timelineContainer.addEventListener('scroll', () => {
            expandTimeline();
        });

        function setupScrubber(scrubber, leftHandle, rightHandle) {
            // Dragging the scrubber body
            scrubber.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('resize-handle')) return;

                isDragging = true;
                activeScrubber = scrubber;
                offsetX = e.clientX - scrubber.offsetLeft;
            });

            // Resizing with left handle
            leftHandle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isResizing = true;
                resizeMode = 'left';
                activeScrubber = scrubber;
                startX = e.clientX;
                startLeft = scrubber.offsetLeft;
                startWidth = scrubber.offsetWidth;
            });

            // Resizing with right handle
            rightHandle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isResizing = true;
                resizeMode = 'right';
                activeScrubber = scrubber;
                startX = e.clientX;
                startLeft = scrubber.offsetLeft;
                startWidth = scrubber.offsetWidth;
            });
        }

        // Setup both scrubbers
        setupScrubber(scrubber1, leftHandle1, rightHandle1);
        setupScrubber(scrubber2, leftHandle2, rightHandle2);

        document.addEventListener('mousemove', (e) => {
            if (!activeScrubber) return;

            const otherScrubber = activeScrubber === scrubber1 ? scrubber2 : scrubber1;

            if (isDragging) {
                let newLeft = e.clientX - offsetX;
                const min = 0;
                const max = timelineWidth - activeScrubber.offsetWidth;
                newLeft = Math.max(min, Math.min(max, newLeft));

                // Store original position
                const originalLeft = activeScrubber.offsetLeft;
                activeScrubber.style.left = `${newLeft}px`;

                // Check for collision
                if (checkCollision(activeScrubber, otherScrubber)) {
                    // Revert to original position if collision detected
                    activeScrubber.style.left = `${originalLeft}px`;
                }

                // Auto-scroll when dragging near edges
                const scrollSpeed = 10;
                const scrollThreshold = 100;
                const containerRect = timelineContainer.getBoundingClientRect();
                const mouseX = e.clientX;

                if (mouseX < containerRect.left + scrollThreshold) {
                    timelineContainer.scrollLeft -= scrollSpeed;
                } else if (mouseX > containerRect.right - scrollThreshold) {
                    timelineContainer.scrollLeft += scrollSpeed;
                    // Check if we need to expand the timeline
                    expandTimeline();
                }

            } else if (isResizing) {
                const deltaX = e.clientX - startX;

                if (resizeMode === 'left') {
                    let newLeft = startLeft + deltaX;
                    let newWidth = startWidth - deltaX;

                    if (activeScrubber.offsetWidth === MINIMUM_WIDTH && deltaX > 0) {
                        return;
                    }

                    // Store original values
                    const originalLeft = activeScrubber.offsetLeft;
                    const originalWidth = activeScrubber.offsetWidth;

                    // Constraints
                    newLeft = Math.max(0, newLeft);
                    newWidth = Math.max(MINIMUM_WIDTH, newWidth);

                    if (newLeft === 0) {
                        newWidth = startLeft + startWidth;
                    }

                    if (newLeft + newWidth > timelineWidth) {
                        newWidth = timelineWidth - newLeft;
                    }

                    // Apply changes
                    activeScrubber.style.left = `${newLeft}px`;
                    activeScrubber.style.width = `${newWidth}px`;

                    // Check for collision
                    if (checkCollision(activeScrubber, otherScrubber)) {
                        // Revert to original position and width
                        activeScrubber.style.left = `${originalLeft}px`;
                        activeScrubber.style.width = `${originalWidth}px`;
                    }
                } else if (resizeMode === 'right') {
                    let newWidth = startWidth + deltaX;
                    const originalWidth = activeScrubber.offsetWidth;

                    // Constraints
                    newWidth = Math.max(MINIMUM_WIDTH, newWidth);

                    if (startLeft + newWidth > timelineWidth) {
                        // Expand timeline if needed
                        if (expandTimeline()) {
                            // If timeline was expanded, allow the resize to continue
                            newWidth = startWidth + deltaX;
                        } else {
                            newWidth = timelineWidth - startLeft;
                        }
                    }

                    // Apply changes
                    activeScrubber.style.width = `${newWidth}px`;

                    // Check for collision
                    if (checkCollision(activeScrubber, otherScrubber)) {
                        // Revert to original width
                        activeScrubber.style.width = `${originalWidth}px`;
                    }
                }
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            isResizing = false;
            resizeMode = null;
            activeScrubber = null;
        });

        // Prevent text selection during drag operations
        document.addEventListener('selectstart', (e) => {
            if (isDragging || isResizing) {
                e.preventDefault();
            }
        });
    </script>

</body>

</html>